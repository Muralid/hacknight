{% extends "layout.html" %}
{% from "comments.html" import commenttree %}
{% from "forms.html" import renderform, ajaxform %}

{% block title %}{{ project.title }} &mdash; {{ event.title }}{% endblock %}
{% block headline %}{% endblock %}
{% block content %}

<div class="breadcrumbs">
  <a href="{{ url_for('event_view', profile=profile.name, event=event.name) }}">&larr; Return to {{ event.title }}</a>
  {% if g.user in project.users %}| <a href="{{ url_for('project_remove', profile=profile.name,
  event=event.name, project=project.url_name) }}">Delete this </a> | <a href="{{ url_for('project_edit', profile=profile.name, event=event.name, project=project.url_name) }}">Edit this &rarr;</a>{% endif %}
</div>
<div class="infosheet">
  <div class="leftear">
    {%- if project.getprev() -%}
      <a href="{{ url_for('prevsession', profile=profile.name, event=event.name, project=project.url_name) }}" title="Previous">&lt;</a>
    {%- else -%}
      <span>&lt;</span>
    {%- endif -%}
  </div>
  <div class="rightear">
    {%- if project.getnext() -%}
      <a href="{{ url_for('nextsession', profile=profile.name, event=event.name, project=project.url_name) }}" title="Next">&gt;</a>
    {%- else -%}
      <span>&gt;</span>
    {%- endif -%}
  </div>
  <div class="section first">
      <h1>{{ project.title }}</h1>
      <div class="votebox">
      {%- set vote = project.votes.getvote(g.user) %}
      <div class="choices">

        {%- if not vote %}
          <a class="votechoice" title="Vote up" href="{{ url_for('voteupsession', profile=profile.name, event=event.name, project=project.url_name) }}">+1</a>
          <a class="votechoice" title="Vote down" href="{{ url_for('votedownsession', profile=profile.name, event=event.name, project=project.url_name) }}">-1</a>
        {%- elif vote.votedown %}
          <a class="votechoice" title="Vote up" href="{{ url_for('voteupsession', profile=profile.name, event=event.name, project=project.url_name) }}">+1</a>
          <a class="votechoice selected" title="Withdraw vote" href="{{ url_for('votecancelsession', profile=profile.name, event=event.name, project=project.url_name) }}">-1</a>
        {%- else %}
          <a class="votechoice selected" title="Withdraw vote" href="{{ url_for('votecancelsession', profile=profile.name, event=event.name, project=project.url_name) }}">+1</a>
          <a class="votechoice" title="Vote down" href="{{ url_for('votedownsession', profile=profile.name, event=event.name, project=project.url_name) }}">-1</a>
        {% endif %}
        <span class="indicator">&rarr;</span>
        <span class="score">
          {%- if project.votes.count > 0 -%}
            +
          {%- endif -%}
          {{ project.votes.count }}</span>
        </div>
      <div class="label">
        Vote on this project
      </div>
    </div>
    
    <div class="useractions">
      by <strong>{{ project.members.filter_by(status=0).first().participant.user.fullname }}</strong>
      {% if project.user == project.speaker -%}
        (speaking) |
      {%- else -%}
        (proposing) |
      {%- endif %}
      {% if project.user == g.user -%}
        <small>(thatâ€™s you! <a href="{{ url_for('editsession', name=event.name, slug=project.url_name) }}">Edit this</a>?)</small>
      {%- endif %}
      {% if userIsMember -%}
        <small> you're part of this team!</small>
      {%- else -%}
        <a class="btn btn-primary" href="{{ url_for('join', profile=profile.name, event=event.name, project=project.url_name) }}">Join this Team</a>
      {%- endif %}
      
    </div>


    
    <!-- Social buttons -->
    <div class="social">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="hasgeek">Tweet</a>
    </div>
    
  </div>
  
  <div class="section">
    <h2>Description</h2>
    <p>{{ project.description|safe }}</p>
  </div>
  
  <div class="section">
      <h2>Accepted Team Members</h2>
      <ul>
        {% for participant in project.participants %}
          <li>{{ participant.user.fullname }}</li>
        {% endfor %}
      </ul>
  </div>

  <div class="section">
    <h2 id="comments">Comments</h2>
    {% if comments %}
      <ul class="comments">
        {{ commenttree(comments, project, g.user, request.base_url) }}
      </ul>
    {% endif %}
    {% if not g.user -%}
      <p>
        <a href="{{ url_for('login') }}">Login with Twitter or Google to leave a comment &rarr;</a>
      </p>
    {% else -%}
      <p id="toplevel-comment" class="hidden">
        <a href="#">Post a comment &rarr;</a>
      </p>
      <form method="POST" id="newcomment">
        <div class="hidden">
          <input type="hidden" name="form.id" value="newcomment"/>
          {{ commentform.hidden_tag() }}
          {{ commentform.parent_id() }}
          {{ commentform.edit_id() }}
        </div>
        <p>
          {{ commentform.message() }}
        </p>
        <p>
          <input id="comment-submit" type="submit" value="Post comment"/>
        </p>
      </form>
      <form method="POST" id="delcomment" class="hidden">
        <div class="hidden">
          <input type="hidden" name="form.id" value="delcomment"/>
          {{ delcommentform.hidden_tag() }}
          {{ delcommentform.comment_id() }}
        </div>
        <p>
          Really delete this comment?
          <input id="comment-delete-submit" type="submit" value="Delete"/>
          or <a id="comment-delete-cancel" href="#">cancel</a>
        </p>
      </form>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block footerscripts %}
<script type="text/javascript">
  $(function() {
    commentsInit("{{ request.base_url }}")});
    </script>
{% endblock %}
